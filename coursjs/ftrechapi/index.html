<html>
  <head>
    <script>
      async function Login() {
        let myHeaders = new Headers();
        let body = {
          username: "peguy",
          password: "peguy",
        };

        myHeaders.append("Content-Type", "application/json");
        const response = await fetch("https://kuz.iotalink.fr/_login/local/", {
          method: "POST",
          headers: myHeaders,
          body: JSON.stringify(body),
        });
        let res = await response.json();
        console.log(res);

        var jwt = await res.result.jwt;
        console.log(jwt);
        localStorage.setItem("jwt", jwt);
        var element = document.getElementById("getid");
        element.removeAttribute("disabled");
      }

      function formatDate(date) {
        return date;
      }

      function update() {
        const element = document.getElementById("inputupdate").value;
        const textforupdate = document.querySelector("#textupdate");
        const requestOptions = {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ "categorie": "Test" }),
          Authorization: "Bearer " + jwt,
          "Content-Type": "application/json",
        };
        fetch(`https://kuz.iotalink.fr/catalogue/produit/${element}/_update`, requestOptions)
          .then((response) => response.json())
          .then((data) => (textforupdate.innerHTML = data));
          
      }

      function get(jwt) {
        myHeaders2 = new Headers({
          Authorization: "Bearer " + get(localStorage.getItem('jwt')),
          "Content-Type": "application/json",
        });
        fetch("https://kuz.iotalink.fr/catalogue/produit", {
          headers: myHeaders2,
          method: "GET",
        })
          .then((response) => response.json())
          .then((result) => {
            var count = Object.keys(result.result.hits).length;
            for (i = 0; i <= count - 1; i++) {
              console.log(result.result.hits[i]);

              var br = document.createElement("br");
              document.body.appendChild(br);
              var para = document.createElement("p");

              if (result.result.hits[i]._source.categorie == undefined) {
                result.result.hits[i]._source.categorie = "Non dÃ©finie";
              }

              const node = document.createTextNode(
                `ID: ${JSON.stringify(
                  result.result.hits[i]._id
                )}  Categorie: ${JSON.stringify(
                  result.result.hits[i]._source.categorie
                )}  NomSource: ${JSON.stringify(
                  result.result.hits[i]._source.name
                )} : ${formatDate(
                  JSON.stringify(
                    result.result.hits[i]._source._kuzzle_info.createdAt
                  )
                )}`
              );
              document.body.appendChild(node);
            }
          })
          .catch((error) => {
            console.error(error);
          });
      }
    </script>
  </head>

  <body>
    <button onclick="Login()">Login</button>

    <button
      id="getid"
      disabled="disabled"
      onclick="get(localStorage.getItem('jwt'))"
    >
      GetInfo
    </button>

    <button onclick="update()">Update</button>

    <input id="inputupdate" name="Test"> </input>

<p id="textupdate">Text for update</p>

  </body>
</html>
